#!/bin/bash
SUB_STORE_FILE="$HOME/substore"
TOKEN="$(cat $SUB_STORE_FILE/TOKEN)"
script_version="v2"
nginx_conf="$SUB_STORE_FILE/nginx/nginx-sub.conf"

# Ctrl+C å›æ”¶Nginx
load_cleanup() {
    trap cleanup SIGINT
    cleanup() {
        echo -e "[â³]æ­£åœ¨æ¸…é™¤NginxæœåŠ¡ [pid: $(cat ./nginx/nginx.pid)]"
        kill $(cat ./nginx/nginx.pid)
        echo -e "\033[1A\033[K[âœ“]æ¸…é™¤NginxæœåŠ¡å®Œæˆ"
        exit 0
    }
}

log() {
    echo -e "[$(date "+%Y-%m-%d_%H:%M:%S")]${hide}$@"
}

START_URL(){
am start -a android.intent.action.VIEW -d "$@"
}

SET_TOKEN() {
    if [[ -z "$1" ]]; then
        read -p "è¾“å…¥TOKENå€¼: " TOKEN
    else
      TOKEN="$1"
    fi
    if [[ -z "$TOKEN" ]]; then
        t_TIPS="[âŒ]æ— TOKENè¾“å…¥"
    else
        echo "$TOKEN" > $SUB_STORE_FILE/TOKEN
        t_TIPS="[âœ“]è®¾ç½®TOKENæˆåŠŸ"
    fi
    menu_reset
}
# *æ›´æ–°
update_ALL() {
    log "å¼€å§‹å‡çº§å‰ç«¯ä¸åç«¯"
    cd $HOME/substore
    sh update.sh "$TOKEN"
    sh update_end.sh "$TOKEN"
    menu_reset
    menu_update
}
update_END() {
    log "å¼€å§‹å‡çº§åç«¯"
    cd $HOME/substore
    sh update.sh "$TOKEN"
    menu_reset
    menu_update
}
update_HUB() {
    log "å¼€å§‹å‡çº§å‰ç«¯"
    cd $HOME/substore
    sh update_end.sh "$TOKEN"
    menu_reset
    menu_update
}
update_MUTE() {
    echo "[â³]æ­£åœ¨æ£€æµ‹èœå•ç‰ˆæœ¬"
    online_version=$(curl -s https://raw.githubusercontent.com/lanyi233/lanyi233/master/script/substore/sub | tail -n 1)
    online_version=$(echo $online_version | grep -oP '#v.*' | tr -d '#')
    if [ "$script_version" != "$online_version" ]; then
        if curl -s --connect-timeout 5 https://raw.githubusercontent.com > /dev/null; then
            echo -e "\033[1A\033[K[âŒ›]æ£€æµ‹åˆ°è„šæœ¬æ–°ç‰ˆæœ¬ï¼Œæ­£åœ¨æ›´æ–°"
            curl -s "https://raw.githubusercontent.com/lanyi233/lanyi233/master/script/substore/sub" -o "$HOME/../usr/bin/sub"
            chmod +x $HOME/../usr/bin/sub
            t_TIPS="[ğŸŒ]èœå•æ›´æ–°å®Œæˆ [$script_version >> $online_version]"
        fi
    else
        t_TIPS="[â†©ï¸æ²¡æœ‰æ–°ç‰ˆæœ¬]"
    fi
    echo -e "\033[1A\033[K"
    echo -e "\033[1A\033[1A\033[K"
    menu_update
}
# *è¿è¡Œ
# run() {
    # log "ä»¥é»˜è®¤æ¨¡å¼è¿è¡Œ"
    # cd $HOME/substore
    # load_cleanup
    # nginx -c $nginx_conf
    # node sub-store.bundle.js "$@"
# }
# run_hide() {
    # hide="ï¼»hideï¼½"
    # log "å½“å‰ä½¿ç”¨éšç§æ¨¡å¼è¿è¡Œï¼Œå°†éšè—æ‚¨çš„tokenæ•°æ®"
    # cd $HOME/substore
    # load_cleanup
    # nginx -c $nginx_conf
    # node sub-store.bundle.js "${@:2}" | sed -E 's/(token=)[a-zA-Z0-9-]+/\1***/g'
# }
run() {
(
    cd $SUB_STORE_FILE
    if [[ "$HTML_MODE" = "true" ]]; then
        load_cleanup
        nginx -c $nginx_conf
        log "å·²å¯åŠ¨æœ¬åœ°å‰ç«¯æœåŠ¡ (pid: $(cat ./nginx/nginx.pid)), åœ¨æ¸¸è§ˆå™¨è®¿é—® http://localhost:$(grep 'listen' $nginx_conf | grep -oE '[0-9]+') ä»¥è¿›å…¥å‰ç«¯"
    fi
    if [[ "$HIDE_MODE" = "true" ]]; then
        log "å½“å‰ä½¿ç”¨éšç§æ¨¡å¼è¿è¡Œï¼Œå°†éšè—æ‚¨çš„tokenæ•°æ®"
        node sub-store.bundle.js ${@:1} | sed -E 's/(token=)[a-zA-Z0-9-]+/1***/g'
    else
        log "ä»¥é»˜è®¤æ¨¡å¼è¿è¡Œ"
        node sub-store.bundle.js $@
    fi
)
}
# *å¯åŠ¨
main() {
#!/bin/bash
  if [[ "$1" == "-u" || "$1" == "--update" ]]; then
     update
  elif [[ "$1" == "-h" || "$1" == "--hide" ]]; then
     HIDE_MODE="true"
     HTML_MODE="true"
     run
  elif [[ "$1" == "-r" || "$1" == "--run" ]]; then
     HIDE_MODE="false"
     HTML_MODE="true"
     run
  elif [[ "$1" == "-t" || "$1" == "--token" ]]; then
     SET_TOKEN $2
  else
     menu_start
  fi
}

# â€¢=====[Menu]=====â€¢ #
p_rt="\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[1A\033[K"
p_k="\033[K"
p_r="\033[1A"

p_t_to="=>"
p_t_HOME="Home"
p_t_RUN="Run"
p_t_RESET="Reset"
p_t_UPDATE="Update"
p_t_SETTING="Setting"
p_t_OTHER="Other"

menu_start() {
menu_reset
menu_home
}
menu_reset() {
echo -e "â€¢=====[Sub Storeèœå•]=====â€¢ [${p_t_RESET}]
1.
2.
3.
4.
5.
6.
7.
8.
9.
-----
0."
}
menu_home() {
echo -e "${p_rt}â€¢=====[Sub Storeèœå•]=====â€¢ [${p_t_HOME}]
${p_k}1.è¿è¡ŒSub Store
${p_k}2.æ›´æ–°åç«¯/å‰ç«¯/èœå•
${p_k}3.è®¾ç½®
${p_k}4.å…¶ä»–
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}å½“å‰ç‰ˆæœ¬ [åç«¯: $(cat $HOME/substore/version)] [å‰ç«¯: $(cat $HOME/substore/version_end)]
${p_k}-----
${p_k}0.é€€å‡º"
read -p "è¾“å…¥åºå·: " user_key

case $user_key in
    1)
        menu_run
        ;;
    2)
        menu_update
        ;;
    3)
        menu_setting
        ;;
    4)
        menu_other
        ;;
    0)
        exit 0
        ;;
    *)
        menu_home
        ;;
esac
}
menu_run() {
echo -e "${p_rt}â€¢=====[Sub Storeèœå•]=====â€¢ [${p_t_HOME} ${p_t_to} ${p_t_RUN}]
${p_k}1.è¿è¡Œåç«¯+å‰ç«¯
${p_k}2.ä»…è¿è¡Œåç«¯
${p_k}
${p_k}3.è¿è¡Œåç«¯+å‰ç«¯ [éšç§æ¨¡å¼]
${p_k}4.ä»…è¿è¡Œåç«¯ [éšç§æ¨¡å¼]
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}-----
${p_k}0.è¿”å›"
read -p "è¾“å…¥åºå·: " user_key

case $user_key in
    1)
        HIDE_MODE="false"
        HTML_MODE="true"
        run
        ;;
    2)
        HIDE_MODE="false"
        HTML_MODE="false"
        run
        ;;
    3)
        HIDE_MODE="true"
        HTML_MODE="true"
        run
        ;;
    4)
        HIDE_MODE="true"
        HTML_MODE="false"
        run
        ;;
    0)
        menu_home
        ;;
    *)
        menu_run
        ;;
esac
}
menu_update() {
echo -e "${p_rt}â€¢=====[Sub Storeèœå•]=====â€¢ [${p_t_HOME} ${p_t_to} ${p_t_UPDATE}] $t_TIPS
${p_k}1.æ›´æ–°åç«¯ä¸å‰ç«¯
${p_k}2.ä»…åç«¯ [$(cat $HOME/substore/version)]
${p_k}3.ä»…å‰ç«¯ [$(cat $HOME/substore/version_end)]
${p_k}4.æ›´æ–°èœå•ç•Œé¢
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}-----
${p_k}0.è¿”å›"
read -p "è¾“å…¥åºå·: " user_key

case $user_key in
    1)
        update_ALL
        ;;
    2)
        update_END
        ;;
    3)
        update_HUB
        ;;
    4)
        update_MUTE
        ;;
    0)
        menu_home
        ;;
    *)
        menu_update
        ;;
esac
}
menu_setting() {
echo -e "${p_rt}â€¢=====[Sub Storeèœå•]=====â€¢ [${p_t_HOME} ${p_t_to} ${p_t_SETTING}] $t_TIPS
${p_k}1.è®¾ç½®GitHub TOKEN
${p_k}2.ä¿®æ”¹Nginxé…ç½®
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}-----
${p_k}0.è¿”å›"
read -p "è¾“å…¥åºå·: " user_key

case $user_key in
    1)
        SET_TOKEN
        menu_setting
        ;;
    2)
        vim $nginx_conf
        menu_setting
        ;;
    0)
        menu_home
        ;;
    *)
        menu_setting
        ;;
esac
}
menu_debug() {

echo -e "${p_rt}â€¢=====[Sub Storeèœå•]=====â€¢ [DEBUG] $t_TIPS
${p_k}1.GitHub TOKEN [$(cat $SUB_STORE_FILE/TOKEN)]
${p_k}2.Nginx config [$(grep 'listen' $nginx_conf | grep -oE '[0-9]+')]
${p_k}3.set -x (temp)
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}-----
${p_k}0.è¿”å›"
read -p "è¾“å…¥åºå·: " user_key

case $user_key in
    1)
        SET_TOKEN
        menu_debug
        ;;
    2)
        vim $nginx_conf
        menu_debug
        ;;
    3)
        set -x
        menu_debug
        ;;
    0)
        menu_setting
        ;;
    *)
        menu_denug
        ;;
esac
}
menu_other() {
echo -e "${p_rt}â€¢=====[Sub Storeèœå•]=====â€¢ [${p_t_HOME} ${p_t_to} ${p_t_OTHER}]
${p_k}1.Kill NginxæœåŠ¡
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}
${p_k}9.å…³äºSub Store
${p_k}9.æ­¤è„šæœ¬ä½œè€…ã®TGé¢‘é“
${p_k}-----
${p_k}0.è¿”å›"
read -p "è¾“å…¥åºå·: " user_key

case $user_key in
    1)
        pkill nginx
        menu_other
        ;;
    8)
        START_URL "https://github.com/sub-store-org"
        ;;
    9)
        START_URL "https://t.me/lanyi233_Channel"
        ;;
    0)
        menu_home
        ;;
    debug)
        menu_debug
        ;;
    *)
        menu_other
        ;;
esac
}
echo ""
main $@
#v2